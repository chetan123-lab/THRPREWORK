parameters:
  - name: environmentBranch
    displayName: "Select environment branch"
    type: string
    default: dev
    values:
      - dev
      - qa
      - prod

trigger: none   # disable auto trigger, youâ€™ll select branch manually when running

variables:
  TF_IN_AUTOMATION: true
  TF_INPUT: 0

stages:
  - stage: AFT
    displayName: "Run AFT Terraform"
    jobs:
      - job: RunAFT
        displayName: "AFT Terraform Execution"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          # Checkout AFT repo with selected branch
          - checkout: self
            persistCredentials: true
            clean: true
            fetchDepth: 0
            # Explicit branch checkout
            ref: ${{ parameters.environmentBranch }}

          - task: TerraformInstaller@1
            inputs:
              terraformVersion: '1.8.5'

          - script: terraform init -input=false
            displayName: "Terraform Init - AFT"

          - script: terraform validate
            displayName: "Terraform Validate - AFT"

          - script: terraform plan -out=tfplan
            displayName: "Terraform Plan - AFT"

          - script: terraform apply -auto-approve tfplan
            displayName: "Terraform Apply - AFT"

  - stage: ControlTower
    displayName: "Run Control Tower Terraform"
    dependsOn: AFT
    condition: succeeded()
    jobs:
      - job: RunControlTower
        displayName: "Control Tower Terraform Execution"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          # Checkout Control Tower repo with the same selected branch
          - checkout: git://YourProjectName/control-tower@${{ parameters.environmentBranch }}

          - task: TerraformInstaller@1
            inputs:
              terraformVersion: '1.8.5'

          - script: terraform init -input=false
            displayName: "Terraform Init - Control Tower"

          - script: terraform validate
            displayName: "Terraform Validate - Control Tower"

          - script: terraform plan -out=tfplan
            displayName: "Terraform Plan - Control Tower"

          - script: terraform apply -auto-approve tfplan
            displayName: "Terraform Apply - Control Tower"
